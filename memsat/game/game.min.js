function onscreen(){$("#controls").toggle(500)}var audio=!0;pressKey=null,releaseKey=null,onmusic=null,$(document).ready(function(){function l(e,t){var i="rgb(255, 0, 0)";e==r?o?(i=y.m1,e+=", memristor_h"):(i=y.m2,e+=", memristor_l"):i=y[e],Crafty.e("2D, DOM, bullet, "+e).attr({x:t._x+32,y:t._y+32,rotation:t._rotation,xspeed:20*Math.sin(t._rotation/57.3),yspeed:20*Math.cos(t._rotation/57.3),high_res:o}).origin("center").bind("EnterFrame",function(){this.x+=this.xspeed,this.y-=this.yspeed,(this._x>Crafty.viewport.width||this._x<0||this._y>Crafty.viewport.height||this._y<0)&&this.destroy()}),Crafty.audio.play("weapon")}function u(e,t){return e.obj._element.className.indexOf(t)>-1}function c(){if(void 0!=localStorage.local_high)try{high_score.text("Personal Best: "+localStorage.local_high)}catch(e){return console.warn(e),void setTimeout(c,100)}firebase.database().ref("/release/memsat/").once("value").then(function(e){var t=e.val(),a=0,s=void 0;for(i in t)a<t[i].score&&(a=t[i].score,s=void 0!=t[i].username?t[i].username:"Anonymous");global_high_score.text("Global: "+a+" - "+s)})}function p(e){setTimeout(c,100),0!=e&&(localStorage.local_high=Math.max(e,localStorage.local_high),userid=firebase.auth().currentUser,updates={score:e},void 0!=firebase.auth().currentUser&&(updates.user=firebase.auth().currentUser.uid,updates.username=firebase.auth().currentUser.displayName),firebase.database().ref("/release/memsat/").push(updates))}var e="resistor",t="capacitor",a="inductor",s="mosfet",r="memristor",o=!1,n=5,h=3,f=100,m=500,d=960;window.innerWidth<960&&(m=.8*window.innerHeight,d=window.innerWidth-48),Crafty.init(d,m,document.getElementById("game")),Crafty.load({images:["memsat/game/sprite.png","memsat/game/bg.png","memsat/game/bullets.png"]},function(){Crafty.sprite(64,"memsat/game/sprite.png",{ship:[0,0],lo_f_hi_v:[1,0],hi_f_lo_v:[2,0],lo_f_lo_v:[3,0],hi_f_hi_v:[4,0]}),Crafty.sprite(7,"memsat/game/bullets.png",{resistor:[0,0],capacitor:[1,0],inductor:[2,0],memristor_l:[3,0],memristor_h:[4,0],mosfet:[5,0]}),Crafty.scene("main")}),Crafty.audio.add("rocket","memsat/game/ship_moving.ogg"),Crafty.audio.add("weapon","memsat/game/weapon.ogg"),Crafty.audio.add("bgm","memsat/game/bgm.ogg");var y={};y[e]="rgb(153, 51, 0)",y[t]="rgb(255, 255, 0)",y[s]="rgb(0, 255, 0)",y[a]="rgb(255, 255, 255)",y.m1="rgb(255, 51, 153)",y.m2="rgb(0, 0, 255)",(void 0==localStorage.local_high||NaN==localStorage.local_high||"NaN"==localStorage.local_high)&&(localStorage.local_high=0),setTimeout(c,100),high_score=void 0,global_high_score=void 0,Crafty.scene("main",function(){function i(e){g.score+=e,y.text("Score: "+g.score)}function C(){var e=Math.max(3,.4*g.level),t=20,i=.8*g.level;return Math.max(Math.min(i,t),e)}function w(){var e=Math.max(1,.4*g.level),t=4,i=.3*g.level;return Math.max(Math.min(i,t),e)}function x(){return Math.random()<.5?Crafty.math.randomInt(0,64):Crafty.viewport.width-Crafty.math.randomInt(0,64)}function b(e){var t=Crafty.math.randomInt(-e,e);return 0==t&&(t=Math.random()),t}function k(e,t){var i=Crafty.math.randomInt(e,t);v=i,_=i;for(var a=0;i>a;a++)Crafty.e("2D, DOM, big, Collision, enemy")}var m=0,d=0;document.getElementById("game").addEventListener("touchstart",function(e){m=e.touches[0].screenX,d=e.touches[0].screenY}),document.getElementById("game").addEventListener("touchmove",function(e){g.xspeed=(e.touches[0].screenX-m)/5,g.yspeed=(e.touches[0].screenY-d)/5,g.xspeed>0&&g.yspeed<0?g.rotation=45:g.xspeed>0&&g.yspeed>0?g.rotation=135:g.xspeed<0&&g.yspeed<0?g.rotation=-45:g.rotation=225,m+=(e.touches[0].screenX-m)/45,d+=(e.touches[0].screenY-d)/45,console.log(g.xspeed,g.yspeed,g.rotation),e.preventDefault()}),document.getElementById("game").addEventListener("touchend",function(e){g.xspeed=0,g.yspeed=0}),Crafty.background("url('memsat/game/bg.png')"),pressKey=function(e){var t=$.Event("keydown");t.which=e,t.keyCode=e,g.trigger("KeyDown",t)},releaseKey=function(e){var t=$.Event("keyup");t.which=e,t.keyCode=e,g.trigger("KeyUp",t)},onmusic=function(){audio=!audio,audio?($("#music").html("Disable Audio"),Crafty.audio.unmute()):($("#music").html("Enable Audio"),Crafty.audio.mute())},Crafty.audio.stop("bgm"),Crafty.audio.play("bgm",-1,.4);var y=Crafty.e("2D, DOM, Text").text("Score: 0").attr({x:Crafty.viewport.width-200,y:Crafty.viewport.height-70,w:200,h:50}).css({color:"#fff"}),c=Crafty.e("2D, DOM, Text").text("HP: "+h).attr({x:20,y:Crafty.viewport.height-50,w:200,h:50}).css({color:"#fff"});high_score=Crafty.e("2D, DOM, Text").text("LOADING PERSONAL BEST").attr({x:Crafty.viewport.width-200,y:Crafty.viewport.height-50,w:200,h:20}).css({color:"#fff"}),global_high_score=Crafty.e("2D, DOM, Text").text("LOADING GLOBAL BEST").attr({x:Crafty.viewport.width-200,y:Crafty.viewport.height-30,w:200,h:20}).css({color:"#fff"});var v,_,g=Crafty.e("2D, Canvas, ship, Controls, Collision").attr({move:{left:!1,right:!1,up:!1,down:!1},xspeed:0,yspeed:0,decay:.9,level:1,x:Crafty.viewport.width/2,y:Crafty.viewport.height/2,hit_points:h,score:0}).origin("center").bind("KeyDown",function(i){i.keyCode===Crafty.keys.RIGHT_ARROW?this.move.right=!0:i.keyCode===Crafty.keys.LEFT_ARROW?this.move.left=!0:i.keyCode===Crafty.keys.UP_ARROW?(this.move.up=!0,Crafty.audio.play("rocket",-1)):i.keyCode===Crafty.keys.SPACE?l(e,this):i.keyCode==Crafty.keys.C?l(t,this):i.keyCode==Crafty.keys.M||i.keyCode==Crafty.keys.ENTER?l(r,this):i.keyCode==Crafty.keys.I||i.keyCode==Crafty.keys.L?l(a,this):i.keyCode==Crafty.keys.N&&l(s,this)}).bind("KeyUp",function(e){e.keyCode===Crafty.keys.RIGHT_ARROW?this.move.right=!1:e.keyCode===Crafty.keys.LEFT_ARROW?this.move.left=!1:e.keyCode===Crafty.keys.UP_ARROW&&(this.move.up=!1,Crafty.audio.stop("rocket"))}).bind("EnterFrame",function(){this.move.right&&(this.rotation+=5),this.move.left&&(this.rotation-=5);var e=.3*Math.sin(this._rotation*Math.PI/180),t=.3*Math.cos(this._rotation*Math.PI/180);this.move.up?(this.yspeed-=t,this.xspeed+=e):(this.xspeed*=this.decay,this.yspeed*=this.decay),this.xspeed=Math.min(this.xspeed,20),this.yspeed=Math.min(this.yspeed,20),this.xspeed=Math.max(this.xspeed,-20),this.yspeed=Math.max(this.yspeed,-20),this.x+=this.xspeed,this.y+=this.yspeed,this._x>Crafty.viewport.width&&(this.x=-64),this._x<-64&&(this.x=Crafty.viewport.width),this._y>Crafty.viewport.height&&(this.y=-64),this._y<-64&&(this.y=Crafty.viewport.height),0>=v&&(k(_,1.3*_),Math.random()>.5&&this.hit_points++,this.level++,i(5),this.immune=(new Date).getTime()+500),this.immune+f>(new Date).getTime()?(this.addComponent("immune"),this.alpha=.5):(this.removeComponent("immune"),this.alpha=1)}).collision().onHit("enemy",function(e){return this.immune+f>(new Date).getTime()?void console.log("I am immune"):(e[0].obj.destroy(),v--,this.immune=(new Date).getTime(),g.hit_points--,c.text("HP: "+g.hit_points),void(g.hit_points<=0&&(p(g.score),Crafty.scene("main"))))});Crafty.c("enemy",{init:function(){this.origin("center"),this.attr({x:x(),y:Crafty.math.randomInt(0,Crafty.viewport.height),rspeed:Crafty.math.randomInt(-1,1),hi_freq:Math.random()>.5,hi_volt:Math.random()>.5,immune:0,hit_points:Crafty.math.randomInt(2,n)}).attr({xspeed:b(C()),yspeed:b(w())}).addComponent(this.hi_freq?this.hi_volt?"hi_f_hi_v":"hi_f_lo_v":this.hi_volt?"lo_f_hi_v":"lo_f_lo_v").bind("EnterFrame",function(){this.x+=this.xspeed,this.y+=this.yspeed,this.rotation+=this.rspeed/40,this._x>Crafty.viewport.width&&(this.x=-64),this._x<-64&&(this.x=Crafty.viewport.width),this._y>Crafty.viewport.height&&(this.y=-64),this._y<-64&&(this.y=Crafty.viewport.height),this.immune+f>(new Date).getTime()?(this.addComponent("immune"),this.alpha=.5):(this.removeComponent("immune"),this.alpha=1)}).collision().onHit("bullet",function(h){this.immune+f>(new Date).getTime()||(u(h[0],e)?(this.immune=(new Date).getTime(),h[0].obj.destroy(),this.hit_points--):u(h[0],t)&&this.hi_freq?(this.immune=(new Date).getTime(),h[0].obj.destroy(),this.hit_points-=3,i(5)):u(h[0],a)&&!this.hi_freq?(this.immune=(new Date).getTime(),h[0].obj.destroy(),this.hit_points-=3,i(5)):u(h[0],r)?(this.immune=(new Date).getTime(),h[0].obj.destroy(),this.hi_volt&&(o=!o),h[0].obj.high_res?(this.hit_points-=n,i(3)):this.hit_points--):u(h[0],s)&&(this.hit_points-=n,i(-5)),this.hit_points<=0&&(i(10),this.destroy(),v--))})}}),k(2,3)}),window.addEventListener("keydown",function(e){[32,37,38,39,40].indexOf(e.keyCode)>-1&&e.preventDefault()},!1)});
